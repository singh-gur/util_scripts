#!/bin/bash

set -e
set -u
set -o pipefail

# S3 Sync Utility
# Syncs data between local filesystem and S3 using AWS CLI sync command
# Leverages AWS's built-in incremental sync capabilities

VERSION="1.2.0"
SCRIPT_NAME=$(basename "$0")

# Default configuration
SOURCE=""
DESTINATION=""
PROFILE="default"
REGION="us-east-1"
DRY_RUN=false
VERBOSE=false
DELETE=false
INCLUDE=""
EXCLUDE=""
SIZE_ONLY=false
EXACT_TIMESTAMPS=false
BACKGROUND=false

# Argument tracking
ORIGINAL_ARGS=()
CHILD_ARGS=()

# Temporary files
TEMP_DIR="/tmp/s3_sync_$$"
mkdir -p "$TEMP_DIR"
CLEANUP_FILES=()

cleanup() {
    local exit_code=$?
    echo "Cleaning up temporary files..."
    for file in "${CLEANUP_FILES[@]}"; do
        if [[ -f "$file" ]]; then
            rm -f "$file"
            echo "Removed: $file"
        fi
    done
    rmdir "$TEMP_DIR" 2>/dev/null || true
    exit $exit_code
}

trap cleanup EXIT

# Logging functions
log_info() {
    echo "[INFO] $1"
}

log_error() {
    echo "[ERROR] $1" >&2
}

log_verbose() {
    if [[ "$VERBOSE" == true ]]; then
        echo "[VERBOSE] $1"
    fi
}

# Help function
usage() {
    cat << EOF
Usage: $SCRIPT_NAME [options] <source> <destination>

Sync data between local filesystem and S3 using AWS CLI sync command.

Arguments:
  source        Source path (local directory or s3://bucket/path)
  destination   Destination path (local directory or s3://bucket/path)

Options:
  -p, --profile PROFILE    AWS profile to use (default: default)
  -r, --region REGION     AWS region (default: us-east-1)
  --dry-run              Show what would be done without making changes
  -v, --verbose          Enable verbose output
  --delete               Delete files in destination that don't exist in source
  --include PATTERN      Include only files matching pattern (glob)
  --exclude PATTERN      Exclude files matching pattern (glob)
  --size-only            Compare files by size only (faster)
  --exact-timestamps     Compare files by exact timestamps (more accurate)
  --background           Run sync in a detached tmux session
  -h, --help             Show this help message

Examples:
  $SCRIPT_NAME ./local_dir s3://my-bucket/remote_dir
  $SCRIPT_NAME s3://my-bucket/remote_dir ./local_backup --profile production --region us-west-2
  $SCRIPT_NAME ./data s3://bucket/data --delete --verbose
  $SCRIPT_NAME s3://bucket/data ./local --include "*.txt" --exclude "temp/*"
  $SCRIPT_NAME ./data s3://bucket/data --size-only  # Faster sync
  $SCRIPT_NAME ./data s3://bucket/data --exact-timestamps  # More accurate sync
  $SCRIPT_NAME ./data s3://bucket/data --background  # Run in detached tmux session

EOF
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -p|--profile)
                PROFILE="$2"
                shift 2
                ;;
            -r|--region)
                REGION="$2"
                shift 2
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            --delete)
                DELETE=true
                shift
                ;;
            --include)
                INCLUDE="$2"
                shift 2
                ;;
            --exclude)
                EXCLUDE="$2"
                shift 2
                ;;
            --size-only)
                SIZE_ONLY=true
                shift
                ;;
            --exact-timestamps)
                EXACT_TIMESTAMPS=true
                shift
                ;;
            --background)
                BACKGROUND=true
                shift
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            -*)
                log_error "Unknown option: $1"
                usage
                exit 1
                ;;
            *)
                if [[ -z "$SOURCE" ]]; then
                    SOURCE="$1"
                elif [[ -z "$DESTINATION" ]]; then
                    DESTINATION="$1"
                else
                    log_error "Too many arguments"
                    usage
                    exit 1
                fi
                shift
                ;;
        esac
    done

    # Validate required arguments
    if [[ -z "$SOURCE" || -z "$DESTINATION" ]]; then
        log_error "Source and destination are required"
        usage
        exit 1
    fi
}

# Validate AWS dependencies
validate_dependencies() {
    local missing_deps=()
    
    if ! command -v aws &> /dev/null; then
        missing_deps+=("awscli")
    fi
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        log_error "Missing required dependencies: ${missing_deps[*]}"
        log_error "Please install the missing packages and try again."
        exit 1
    fi
}

# Check if path is S3
is_s3_path() {
    local path="$1"
    [[ "$path" == s3://* ]]
}

build_child_args() {
    CHILD_ARGS=()
    for arg in "${ORIGINAL_ARGS[@]}"; do
        if [[ "$arg" == "--background" ]]; then
            continue
        fi
        CHILD_ARGS+=("$arg")
    done
}

launch_in_background() {
    build_child_args

    if [[ ${#CHILD_ARGS[@]} -eq 0 ]]; then
        log_error "No arguments supplied for background execution"
        exit 1
    fi

    if ! command -v tmux >/dev/null 2>&1; then
        log_error "--background requires tmux to be installed"
        exit 1
    fi

    local timestamp session_name base_session command_string=""
    timestamp=$(date +%s)
    base_session="s3_sync_${timestamp}"
    session_name="$base_session"

    local counter=1
    while tmux has-session -t "$session_name" 2>/dev/null; do
        session_name="${base_session}_$counter"
        ((counter++))
    done

    local cmd=("$0" "${CHILD_ARGS[@]}")
    local part=""
    for arg in "${cmd[@]}"; do
        printf -v part '%q' "$arg"
        command_string+=" $part"
    done

    command_string=${command_string# }

    log_info "Launching sync in background via tmux session: $session_name"

    if ! tmux new-session -d -s "$session_name" "$command_string"; then
        log_error "Failed to create tmux session"
        exit 1
    fi

    log_info "Attach with: tmux attach -t $session_name"
    log_info "Detach with: Ctrl-b then d"
}

# Main sync function
perform_sync() {
    local source_is_s3=false
    local dest_is_s3=false
    
    # Determine source type
    if is_s3_path "$SOURCE"; then
        source_is_s3=true
    fi
    
    # Determine destination type  
    if is_s3_path "$DESTINATION"; then
        dest_is_s3=true
    fi
    
    # Validate sync direction
    if [[ "$source_is_s3" == "$dest_is_s3" ]]; then
        log_error "Both source and destination cannot be the same type (both S3 or both local)"
        exit 1
    fi
    
    # Build AWS sync command
    local aws_cmd="aws s3 sync"
    
    # Add profile if specified
    if [[ "$PROFILE" != "default" ]]; then
        aws_cmd+=" --profile $PROFILE"
    fi
    
    # Add region if specified
    if [[ "$REGION" != "us-east-1" ]]; then
        aws_cmd+=" --region $REGION"
    fi
    
    # Add dry run flag
    if [[ "$DRY_RUN" == true ]]; then
        aws_cmd+=" --dryrun"
    fi
    
    # Add delete flag
    if [[ "$DELETE" == true ]]; then
        aws_cmd+=" --delete"
    fi
    
    # Add verbose flag
    if [[ "$VERBOSE" == true ]]; then
        aws_cmd+=" --debug"
    fi
    
    # Add performance options
    if [[ "$SIZE_ONLY" == true ]]; then
        aws_cmd+=" --size-only"
    fi
    
    if [[ "$EXACT_TIMESTAMPS" == true ]]; then
        aws_cmd+=" --exact-timestamps"
    fi
    
    # Add include/exclude patterns
    if [[ -n "$INCLUDE" ]]; then
        aws_cmd+=" --include $INCLUDE"
    fi
    
    if [[ -n "$EXCLUDE" ]]; then
        aws_cmd+=" --exclude $EXCLUDE"
    fi
    
    # Add source and destination
    aws_cmd+=" $SOURCE $DESTINATION"
    
    log_info "Executing: $aws_cmd"
    
    # Execute the sync command
    if ! $aws_cmd; then
        log_error "AWS sync command failed"
        exit 1
    fi
    
    log_info "Sync completed successfully"
}

# Main function
main() {
    ORIGINAL_ARGS=("$@")
    parse_args "$@"

    if [[ "$BACKGROUND" == true ]]; then
        launch_in_background
        exit 0
    fi

    validate_dependencies
    
    log_info "Starting S3 Sync Utility v$VERSION"
    log_info "Source: $SOURCE"
    log_info "Destination: $DESTINATION"
    log_info "Profile: $PROFILE"
    log_info "Region: $REGION"
    log_info "Dry run: $DRY_RUN"
    log_info "Verbose: $VERBOSE"
    log_info "Delete: $DELETE"
    
    if [[ "$DRY_RUN" == true ]]; then
        log_info "Dry run mode - no changes will be made"
    fi
    
    perform_sync
    log_info "Sync completed successfully"
}

main "$@"