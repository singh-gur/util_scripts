#!/bin/bash

set -e
set +v

SSH_CONFIG="${HOME}/.ssh/config"
PROXY=""
TARGET=""
LIST_ONLY=""
VERBOSE=""

usage() {
cat << EOF
usage: ssh_proxy <options>
    -t, --target HOST       Target server to SSH into (from ~/.ssh/config)
    -p, --proxy HOST        Proxy/jump server to use
    -l, --list              List available hosts from ~/.ssh/config and exit
    -v, --verbose           Show verbose output
    -h, --help              Show this help message

Examples:
    ssh_proxy --list                         # List all available hosts
    ssh_proxy --target=webserver             # SSH to webserver (auto-detect proxy if configured)
    ssh_proxy -t dbserver -p bastion         # SSH to dbserver through bastion
    ssh_proxy -t app -v                      # SSH with verbose output

EOF
}

error() {
    echo "ERROR: $1" >&2
    exit 1
}

parse_ssh_config() {
    local config_file="$1"

    if [[ ! -f "$config_file" ]]; then
        return 1
    fi

    awk '
        /^[[:space:]]*Host[[:space:]]/ {
            sub(/^[[:space:]]*Host[[:space:]]*/, "")
            gsub(/[[:space:]]+/, "\n")
            for (i = 1; i <= NF; i++) {
                if ($i != "*" && $i != "")
                    print tolower($i)
            }
            next
        }
    ' "$config_file" 2>/dev/null | sort -u
}

get_host_config() {
    local config_file="$1"
    local target_host="$2"
    local setting="$3"

    target_host=$(echo "$target_host" | tr '[:upper:]' '[:lower:]')

    awk -v target="$target_host" -v setting="$setting" '
        BEGIN { found = 0 }
        /^(Host|HostName|User|ProxyJump|ProxyCommand)[[:space:]]/ {
            key = tolower($1)
            val = ""
            for (i = 2; i <= NF; i++) val = val (val ? " " : "") $i
            gsub(/^["'\'']|["'\'']$/, "", val)
        }
        key == "host" {
            current = ""
            for (i = 1; i <= NF; i++) {
                gsub(/\*/ , ".*", $i)
                current = current (current ? "|" : "") $i
            }
            if (target ~ "^(" current ")$") {
                found = 1
            } else if (found) {
                exit
            }
            next
        }
        found && tolower(setting) == key {
            print val
            exit
        }
    ' "$config_file"
}

get_hostname() {
    local config_file="$1"
    local host="$2"
    local hostname

    hostname=$(get_host_config "$config_file" "$host" "Hostname")
    if [[ -z "$hostname" ]]; then
        hostname="$host"
    fi
    echo "$hostname"
}

get_user() {
    local config_file="$1"
    local host="$2"
    local user

    user=$(get_host_config "$config_file" "$host" "User")
    echo "$user"
}

get_proxyjump() {
    local config_file="$1"
    local host="$2"
    local proxyjump

    proxyjump=$(get_host_config "$config_file" "$host" "ProxyJump")
    echo "$proxyjump"
}

get_proxycommand() {
    local config_file="$1"
    local host="$2"
    local proxycmd

    proxycmd=$(get_host_config "$config_file" "$host" "ProxyCommand")
    echo "$proxycmd"
}

auto_detect_proxy() {
    local config_file="$1"
    local target="$2"
    local proxyjump

    proxyjump=$(get_proxyjump "$config_file" "$target")
    if [[ -n "$proxyjump" ]]; then
        echo "$proxyjump"
        return 0
    fi

    local proxycmd
    proxycmd=$(get_proxycommand "$config_file" "$target")
    if [[ -n "$proxycmd" ]]; then
        echo "$proxycmd"
        return 0
    fi

    return 1
}

interactive_select() {
    local hosts=("$@")
    local count=${#hosts[@]}
    local choice

    if [[ $count -eq 0 ]]; then
        error "No hosts found in $SSH_CONFIG"
    fi

    echo "Available hosts from ~/.ssh/config:"
    echo "------------------------------------"

    for i in "${!hosts[@]}"; do
        printf "%2d) %s\n" $((i + 1)) "${hosts[$i]}"
    done

    echo ""
    echo -n "Select a host (1-$count) or 'q' to quit: "
    read -r choice

    if [[ "$choice" == "q" || "$choice" == "Q" ]]; then
        echo "Cancelled."
        exit 0
    fi

    if ! [[ "$choice" =~ ^[0-9]+$ ]] || [[ "$choice" -lt 1 || "$choice" -gt $count ]]; then
        error "Invalid selection: $choice"
    fi

    echo "${hosts[$((choice - 1))]}"
}

build_ssh_command() {
    local config_file="$1"
    local target="$2"
    local proxy="$3"
    local verbose="$4"
    local cmd="ssh"
    local target_hostname user

    target_hostname=$(get_hostname "$config_file" "$target")
    user=$(get_user "$config_file" "$target")

    if [[ -n "$verbose" ]]; then
        cmd="$cmd -v"
    fi

    if [[ -n "$proxy" ]]; then
        local proxy_hostname
        proxy_hostname=$(get_hostname "$config_file" "$proxy")
        cmd="$cmd -J $proxy_hostname"
        [[ -n "$verbose" ]] && echo "Using proxy: $proxy -> $proxy_hostname"
    fi

    if [[ -n "$user" ]]; then
        cmd="$cmd $user@$target_hostname"
    else
        cmd="$cmd $target_hostname"
    fi

    [[ -n "$verbose" ]] && echo "Command: $cmd"

    echo "$cmd"
}

main() {
    while [[ $# -gt 0 ]]; do
        PARAM=$(echo "$1" | awk -F= '{print $1}')
        VALUE=$(echo "$1" | awk -F= '{print $2}')
        case $PARAM in
            -t|--target)
                TARGET=$(echo "$VALUE" | tr -d '"')
                if [[ -z "$TARGET" && -n "$2" && ! "$2" =~ ^- ]]; then
                    TARGET="$2"
                    shift
                fi
                ;;
            -p|--proxy)
                PROXY=$(echo "$VALUE" | tr -d '"')
                if [[ -z "$PROXY" && -n "$2" && ! "$2" =~ ^- ]]; then
                    PROXY="$2"
                    shift
                fi
                ;;
            -l|--list)
                LIST_ONLY="Y"
                ;;
            -v|--verbose)
                VERBOSE="Y"
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            *)
                error "Unknown option: $PARAM"
                ;;
        esac
        shift
    done

    if [[ ! -f "$SSH_CONFIG" ]]; then
        error "SSH config not found: $SSH_CONFIG"
    fi

    mapfile -t hosts < <(parse_ssh_config "$SSH_CONFIG")

    if [[ -n "$LIST_ONLY" ]]; then
        if [[ ${#hosts[@]} -eq 0 ]]; then
            echo "No hosts found in $SSH_CONFIG"
        else
            printf '%s\n' "${hosts[@]}"
        fi
        exit 0
    fi

    if [[ -z "$TARGET" ]]; then
        TARGET=$(interactive_select "${hosts[@]}")
    else
        TARGET=$(echo "$TARGET" | tr '[:upper:]' '[:lower:]')
        local found=false
        for h in "${hosts[@]}"; do
            if [[ "$h" == "$TARGET" ]]; then
                found=true
                break
            fi
        done
        if [[ "$found" == false ]]; then
            error "Host '$TARGET' not found in $SSH_CONFIG"
        fi
    fi

    if [[ -z "$PROXY" ]]; then
        if auto_detect_proxy "$SSH_CONFIG" "$TARGET"; then
            PROXY="$?"
        fi
    fi

    ssh_cmd=$(build_ssh_command "$SSH_CONFIG" "$TARGET" "$PROXY" "$VERBOSE")

    if [[ -n "$VERBOSE" ]]; then
        echo "Target: $TARGET"
        echo "Proxy: ${PROXY:-none}"
        echo "Executing: $ssh_cmd"
    fi

    eval "$ssh_cmd"
}

main "$@"
