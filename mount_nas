#!/bin/bash

#display and exit-on-error for all commands
set -e
set +v

echo "Mounting NFS4 directory from NAS server"

# Default values
NAS_IP="192.168.2.119"
SOURCE_BASE="/mnt/ssd_data"
TARGET_BASE="$HOME/nas_mounts"
SUBDIR=""
FORCE=""
VERBOSE=""

usage()
{
cat << eof
usage: mount_nas <options> [subdirectory]
    -s, --server       NAS server IP address (default: 192.168.2.119)
    --source-base      Source base path on NAS server (default: /mnt/ssd_data)
    -t, --target-base  Target base mount directory (default: ~/nas_mounts)
    -f, --force        Force remount if already mounted
    -v, --verbose      Verbose output
    -h, --help         Get usage info

Arguments:
    subdirectory       Optional subdirectory to mount under base paths

Examples:
    mount_nas                                    # Mount base paths (192.168.2.119:/mnt/ssd_data -> ~/nas_mounts)
    mount_nas documents                          # Mount 192.168.2.119:/mnt/ssd_data/documents -> ~/nas_mounts/documents
    mount_nas --server=192.168.1.100 photos     # Mount 192.168.1.100:/mnt/ssd_data/photos -> ~/nas_mounts/photos
    mount_nas --source-base=/data --target-base=/mnt/data backups  # Mount /data/backups -> /mnt/data/backups
    mount_nas --force --verbose media            # Force remount media directory with verbose output
eof
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--server)
            NAS_IP="$2"
            shift 2
            ;;
        --source-base)
            SOURCE_BASE="$2"
            shift 2
            ;;
        -t|--target-base)
            TARGET_BASE="$2"
            shift 2
            ;;
        -f|--force)
            FORCE="Y"
            shift
            ;;
        -v|--verbose)
            VERBOSE="Y"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*|--*)
            echo "Unknown option $1"
            echo "Use -h or --help for usage information"
            exit 1
            ;;
        *)
            # Positional argument - subdirectory
            if [ -z "$SUBDIR" ]; then
                SUBDIR="$1"
            else
                echo "Error: Multiple subdirectories specified"
                echo "Use -h or --help for usage information"
                exit 1
            fi
            shift
            ;;
    esac
done

# Construct full paths
if [ -n "$SUBDIR" ]; then
    SOURCE_PATH="${SOURCE_BASE%/}/${SUBDIR}"
    TARGET_PATH="${TARGET_BASE%/}/${SUBDIR}"
else
    SOURCE_PATH="$SOURCE_BASE"
    TARGET_PATH="$TARGET_BASE"
fi

# Validate NAS IP format
if ! [[ $NAS_IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo "Error: Invalid IP address format: $NAS_IP"
    exit 1
fi

# Expand ~ in target base path before constructing full path
TARGET_BASE="${TARGET_BASE/#\~/$HOME}"

# Reconstruct full paths with expanded home directory
if [ -n "$SUBDIR" ]; then
    SOURCE_PATH="${SOURCE_BASE%/}/${SUBDIR}"
    TARGET_PATH="${TARGET_BASE%/}/${SUBDIR}"
else
    SOURCE_PATH="$SOURCE_BASE"
    TARGET_PATH="$TARGET_BASE"
fi

# Check if target directory exists, create if it doesn't
if [ ! -d "$TARGET_PATH" ]; then
    echo "Creating target directory: $TARGET_PATH"
    mkdir -p "$TARGET_PATH"
    if [ $? -ne 0 ]; then
        echo "Error: Failed to create target directory: $TARGET_PATH"
        exit 1
    fi
fi

# Display mount information
if [ -n "$VERBOSE" ]; then
    echo "NAS Server: $NAS_IP"
    echo "Source Base: $SOURCE_BASE"
    echo "Target Base: $TARGET_BASE"
    if [ -n "$SUBDIR" ]; then
        echo "Subdirectory: $SUBDIR"
    fi
    echo "Full Source Path: $SOURCE_PATH"
    echo "Full Target Path: $TARGET_PATH"
    echo ""
fi

# Check if already mounted
if mountpoint -q "$TARGET_PATH" 2>/dev/null; then
    if [ -n "$FORCE" ]; then
        echo "Target already mounted, forcing remount..."
        sudo umount "$TARGET_PATH" || {
            echo "Error: Failed to unmount existing mount at $TARGET_PATH"
            exit 1
        }
    else
        echo "Target $TARGET_PATH is already mounted"
        echo "Use --force to remount"
        exit 0
    fi
fi

# Check if NFS client is installed
if ! command -v mount.nfs4 &> /dev/null; then
    echo "Error: NFS client not installed"
    echo "Install with: sudo apt-get install nfs-common (Ubuntu/Debian)"
    echo "Or: sudo yum install nfs-utils (CentOS/RHEL)"
    exit 1
fi

# Test connectivity to NAS server
if [ -n "$VERBOSE" ]; then
    echo "Testing connectivity to NAS server at $NAS_IP..."
fi
if ! ping -c 1 -W 5 "$NAS_IP" &> /dev/null; then
    echo "Error: Cannot reach NAS server at $NAS_IP"
    echo "Please check network connectivity and server status"
    exit 1
fi

# Construct the full NFS mount path
NFS_PATH="${NAS_IP}:${SOURCE_PATH}"

# Perform the mount
echo "Mounting NFS4 share: $NFS_PATH -> $TARGET_PATH"

if [ -n "$VERBOSE" ]; then
    echo "Mount command: sudo mount -t nfs4 -o rw,hard,intr,noatime $NFS_PATH $TARGET_PATH"
fi

sudo mount -t nfs4 -o rw,hard,intr,noatime "$NFS_PATH" "$TARGET_PATH"

if [ $? -eq 0 ]; then
    echo "Successfully mounted NFS4 share"
    if [ -n "$VERBOSE" ]; then
        echo "Mount details:"
        df -h "$TARGET_PATH"
        echo ""
        echo "Mount point contents:"
        ls -la "$TARGET_PATH"
    fi
else
    echo "Error: Failed to mount NFS4 share"
    exit 1
fi

echo "NFS4 mount completed successfully"